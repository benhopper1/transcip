<!DOCTYPE html>

<html>
<head>
  <title>upload.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="./docco.css" />
</head>
<body>
<div id="container">
  <table cellspacing="0" cellpadding="0">
    <thead>
    <tr>
      <th class="docs">
        
        <h1>upload.js</h1>
        
      </th>
      <th class="code"></th>
    </tr>
    </thead>
    <tbody>
    
    
    <tr id="section-1">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
      
      </td>
      <td class="code">
      <pre><code ><span class="keyword">var</span> path = <span class="keyword">require</span>(<span class="string">'path'</span>);
<span class="keyword">var</span> basePath = path.dirname(<span class="keyword">require</span>.main.filename);
<span class="keyword">var</span> Model = <span class="keyword">require</span>(<span class="string">'../models/uploadmodel'</span>);
<span class="keyword">var</span> model = <span class="keyword">new</span> Model();
<span class="keyword">var</span> fs = <span class="keyword">require</span>(<span class="string">'fs'</span>);
<span class="keyword">var</span> multiparty = <span class="keyword">require</span>(basePath + <span class="string">'/node_modules/multiparty'</span>);
<span class="keyword">var</span> finish = <span class="keyword">require</span>(basePath + <span class="string">'/node_modules/finish'</span>);
<span class="keyword">var</span> uuid = <span class="keyword">require</span>(basePath + <span class="string">'/node_modules/node-uuid'</span>);

<span class="keyword">var</span> configData = fs.readFileSync(path.dirname(<span class="keyword">require</span>.main.filename) + <span class="string">'/main.conf'</span>, <span class="string">'utf8'</span>);
configData = JSON.parse(configData);

module.exports.controller = function(app){

	</code></pre>
      </td>
    </tr>
    
    
    <tr id="section-2">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
      <p>-----G E T ----------------------------------------</p>
      </td>
      <td class="code">
      <pre><code >	app.<span class="keyword">get</span>(<span class="comment">'/upload', function(req, res){</span>
		console.<span class="built_in">log</span>(<span class="string">"get"</span>)  ;
		console.<span class="built_in">log</span>(<span class="string">"HOST:"</span>+req.hostname);
		console.<span class="built_in">log</span>(<span class="string">"UserName:"</span>+req.session.userName);
		console.<span class="built_in">log</span>(req.body);
		console.<span class="built_in">log</span>(<span class="string">"MODELTEST:"</span> + model.test());

		res.render(<span class="comment">'upload/upload_get.jade',</span>
			{
				data:<span class="comment">'',</span>
				customData:req.custom
			}
		);
	});



		</code></pre>
      </td>
    </tr>
    
    
    <tr id="section-3">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
      <p>-----P O S T ---------------------------------</p>
      </td>
      <td class="code">
      <pre><code >	app.post(<span class="comment">'/upload', function(req, res){</span>
		console.<span class="built_in">log</span>(<span class="comment">'USERID=&gt;:' + req.cookies.userId);</span>

		var form = <span class="keyword">new</span> multiparty.Form();
		form.parse(req, <span class="keyword">function</span>(<span class="built_in">err</span>, fields, files){
			<span class="keyword">if</span>(files.uploadedFile){
				var fieldsHash = {};
				var tmpFilePath = files.uploadedFile[<span class="number">0</span>].path;
				var fileName = files.uploadedFile[<span class="number">0</span>].originalFilename;
				var encoding = <span class="comment">'';</span>
				var mimeType = <span class="comment">'';</span>
				var fieldName =<span class="comment">'';</span>

				var file = fs.createReadStream(tmpFilePath);

				Object.keys(fields).forEach(<span class="keyword">function</span>(name){
					fieldsHash[name] = fields[name][<span class="number">0</span>];
				});

				model.processUploadedFile(
					{
						<span class="built_in">request</span>:<span class="comment">'',</span>
						<span class="built_in">response</span>:<span class="comment">'',</span>
						file:file,
						fileName:fileName,
						encoding:encoding,
						mimeType:mimeType,
						data:fieldsHash,
						onComplete:<span class="keyword">function</span>(inData, <span class="built_in">err</span>){
							console.<span class="built_in">log</span>(<span class="comment">'onComplete of processUploadedFile');</span>
							console.dir(inData);
							console.<span class="built_in">log</span>(<span class="comment">'----------error-----------');</span>
							console.dir(<span class="built_in">err</span>);

							res.setHeader(<span class="comment">'Content-Type', 'application/json');</span>
							res.<span class="keyword">end</span>(JSON.stringify(inData));


						}
					}
				);
			}
			
		});

	});




		</code></pre>
      </td>
    </tr>
    
    
    <tr id="section-4">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
      <p>-----P O S T ---------------------------------</p>
      </td>
      <td class="code">
      <pre><code >	app.post(<span class="comment">'/uploadAsTemp', function(req, res){</span>
		console.<span class="built_in">log</span>(<span class="comment">'USERID=&gt;:' + req.cookies.userId);</span>

		var form = <span class="keyword">new</span> multiparty.Form();
		form.parse(req, <span class="keyword">function</span>(<span class="built_in">err</span>, fields, files){
			<span class="keyword">if</span>(files.uploadedFile){
				var fieldsHash = {};
				var tmpFilePath = files.uploadedFile[<span class="number">0</span>].path;
				var fileName = files.uploadedFile[<span class="number">0</span>].originalFilename;
				var encoding = <span class="comment">'';</span>
				var mimeType = <span class="comment">'';</span>
				var fieldName =<span class="comment">'';</span>

				var file = fs.createReadStream(tmpFilePath);

				Object.keys(fields).forEach(<span class="keyword">function</span>(name){
					fieldsHash[name] = fields[name][<span class="number">0</span>];
				});

				var fileData = 
					{
						<span class="built_in">request</span>:<span class="comment">'',</span>
						<span class="built_in">response</span>:<span class="comment">'',</span>
						file:file,
						fileName:fileName,
						encoding:encoding,
						mimeType:mimeType,
						data:fieldsHash
					}

				inFileNamePath = fileName.<span class="built_in">replace</span>(path.basename(fileName, path.extname(fileName)), uuid.v1());
				</code></pre>
      </td>
    </tr>
    
    
    <tr id="section-5">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
      <p>_this.dbStoreFile(path.join(audioFolderPath, path.basename(inFileNamePath)), inEncoding, inMimeType, '');</p>
      </td>
      <td class="code">
      <pre><code >				var saveTo = <span class="transposed_variable">path.</span>join(basePath + <span class="string">'/public/temp'</span>, <span class="transposed_variable">path.</span>basename(inFileNamePath));
	  			<span class="transposed_variable">file.</span>pipe(<span class="transposed_variable">fs.</span>createWriteStream(saveTo));
	  			<span class="transposed_variable">file.</span>on(<span class="string">'close'</span>, <span class="keyword">function</span>()<span class="cell">{
	  				</code></pre>
      </td>
    </tr>
    
    
    <tr id="section-6">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
      <p>if(inCompleteFunction){</p>
      </td>
      <td class="code">
      <pre><code >	  					<span class="keyword">var</span> tempFileData = 
	  						{
	  							fileName:path.basename(inFileNamePath),
	  							</code></pre>
      </td>
    </tr>
    
    
    <tr id="section-7">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-7">#</a>
        </div>
      <p>domainFilePath:basePath + '/public/temp' + '/' + path.basename(inFileNamePath),</p>
      </td>
      <td class="code">
      <pre><code >	  							domainFilePath:configData.domain.address + ':' + configData.domain.<span class="keyword">port</span> + '/public/temp' + '/' + path.basename(inFileNamePath),
	  							fileNameNoExt:path.basename(inFileNamePath, path.extname(inFileNamePath)),
	  							fileExt:path.extname(inFileNamePath).replace(<span class="string">"."</span>,<span class="string">""</span>)
	  						}
	  					console.log(<span class="attribute">'temp</span> <span class="keyword">file</span> done!!!:');
	  					console.dir(tempFileData);

						res.setHeader(<span class="attribute">'Content</span>-<span class="keyword">Type</span>', <span class="attribute">'application</span>/json');
						res.<span class="keyword">end</span>(JSON.stringify(tempFileData));
	  				</code></pre>
      </td>
    </tr>
    
    
    <tr id="section-8">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-8">#</a>
        </div>
      <p>}</p>
      </td>
      <td class="code">
      <pre><code >				})<span class="comment">;</span>

			}
		})<span class="comment">;</span>

	})<span class="comment">;</span>

















}
</code></pre>
      </td>
    </tr>
    
  </table>
</div>
</body>
</html>



